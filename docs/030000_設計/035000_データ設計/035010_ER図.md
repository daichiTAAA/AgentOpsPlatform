---
title: ER図
version: "0.1"
status: draft
owner: システム開発チーム
updated: 2025-09-07
related_requirements: ["021000_要件定義書", "034020_ユースケース設計"]
---

# 035010 ER図

## 概要

ソロプレナー／AIネイティブ企業基盤システムの主要エンティティとその関係を定義します。人機協調モデルに基づき、人間とAIエージェントの行動・承認・履歴管理を包括的にサポートするデータ構造を設計しています。

**重要**: 本システムはRedmineを中枢管理システムとして活用するため、Redmineの既存テーブル構造を基盤として設計されています。issues, trackers, workflows等のRedmineコアテーブルを活用し、AI機能拡張のための追加テーブルで補完する構成となっています。

## 主要エンティティ群

### 1. 組織・ユーザ管理（Organization Domain - Redmine基盤）
- **Organizations**: 組織・テナント管理
- **Users**: システム利用者（人間・AIエージェント）
- **Roles**: 権限ロール（Admin/Approver/Contributor/Agent）
- **Permissions**: 具体的権限定義
- **AuthSources**: 認証ソース（LDAP/SSO等）
- **Tokens**: APIトークン・認証トークン

### 2. プロジェクト・チケット管理（Project Management Domain - Redmine基盤）
- **Projects**: プロジェクト（戦略実行・調査・開発等）
- **Issues**: Redmineチケット（タスク・バグ・要求等）
- **Trackers**: issue種別（タスク・バグ・機能・調査等）
- **IssueStatuses**: チケットステータス（新規・進行中・解決・終了等）
- **IssueCategories**: プロジェクト内カテゴリ分類
- **Versions**: バージョン・マイルストーン・リリース管理
- **Members**: プロジェクトメンバー管理
- **Workflows**: ワークフロー・ステータス遷移

### 3. 添付ファイル・ドキュメント管理（Document Domain - Redmine基盤）
- **Attachments**: Redmine添付ファイル管理
- **Documents**: プロジェクトドキュメント
- **News**: プロジェクトニュース・お知らせ
- **CustomFields**: カスタムフィールド定義
- **CustomValues**: カスタムフィールド値

### 4. 履歴・監査・ワークフロー管理（Audit Workflow Domain - Redmine基盤）
- **Journals**: 変更履歴・アクティビティログ
- **JournalDetails**: 変更履歴詳細
- **Watchers**: チケット・プロジェクト監視設定
- **Enumerations**: 列挙値・マスタデータ

### 5. AI・実行管理（AI Agent Domain - AI拡張）
- **AIAgents**: AIエージェント定義・設定
- **Executions**: AI実行履歴・ジョブ管理
- **ExecutionResults**: 実行結果・成果物
- **AIIssueLinks**: RedmineチケットとAI実行の連携

### 6. 人機協調・ワークフロー（Collaboration Domain - AI拡張）
- **ApprovalFlows**: HITL承認管理
- **Reviews**: レビュー・フィードバック
- **WorkflowSteps**: ワークフローステップ詳細

### 7. ナレッジ・学習管理（Knowledge Domain - AI拡張）
- **KnowledgeAssets**: 知識資産・ドキュメント
- **KnowledgeVersions**: ナレッジバージョン管理
- **LearningPlans**: 学習計画・カリキュラム
- **LearningProgress**: 学習進捗管理
- **QualityChecks**: 品質チェック結果

### 8. 監査・ガバナンス（Audit Domain - AI拡張）
- **AuditLogs**: 包括的監査ログ
- **ComplianceChecks**: コンプライアンス確認
- **SecurityEvents**: セキュリティイベント

### 9. 統合・拡張管理（Integration Domain - AI拡張）
- **IntegrationConfigs**: 外部システム連携設定
- **IntegrationLogs**: 連携処理ログ

## ER図（Redmine統合版）

以下のER図は、Redmineの既存テーブル構造を基盤として、AI機能拡張のための追加テーブルを統合した設計となっています。

### 1. 組織・ユーザ管理ドメイン（Redmine基盤）

```mermaid
erDiagram
    Organizations {
        UUID organization_id PK
        string organization_name UK
        string domain UK "AI拡張"
        string organization_type "enterprise/individual/team"
        boolean is_active
        datetime created_at
        datetime updated_at
    }
    
    Users {
        UUID user_id PK "Redmine id互換"
        UUID organization_id FK "AI拡張"
        string login UK "Redmine互換"
        string firstname "Redmine互換"
        string lastname "Redmine互換"
        string mail UK "Redmine互換"
        string hashed_password "Redmine互換"
        int status "Redmine互換: 1=active, 2=registered, 3=locked"
        boolean admin "Redmine互換"
        string language "Redmine互換"
        UUID auth_source_id FK "Redmine互換"
        string user_type "AI拡張: human/ai_agent"
        json user_config "AI拡張"
        datetime last_login_on "Redmine互換"
        datetime created_on "Redmine互換"
        datetime updated_on "Redmine互換"
    }
    
    AuthSources {
        UUID auth_source_id PK "Redmine互換"
        string type "Redmine互換"
        string name "Redmine互換"
        string host "Redmine互換"
        int port "Redmine互換"
        string account "Redmine互換"
        string account_password "Redmine互換"
        string base_dn "Redmine互換"
        string attr_login "Redmine互換"
        string attr_firstname "Redmine互換"
        string attr_lastname "Redmine互換"
        string attr_mail "Redmine互換"
        boolean onthefly_register "Redmine互換"
    }
    
    Roles {
        UUID role_id PK "Redmine id互換"
        string name UK "Redmine互換"
        string description "AI拡張"
        boolean is_active "AI拡張"
        datetime created_at
    }
    
    Permissions {
        UUID permission_id PK "Redmine id互換"
        string controller "Redmine互換"
        string action "Redmine互換" 
        string description "Redmine互換"
        boolean is_public "Redmine互換"
        int sort "Redmine互換"
        boolean mail_option "Redmine互換"
        boolean mail_enabled "Redmine互換"
    }
    
    PermissionsRoles {
        UUID permission_id FK "Redmine互換"
        UUID role_id FK "Redmine互換"
    }
    
    Tokens {
        UUID token_id PK
        UUID user_id FK "Redmine互換"
        string action "Redmine互換"
        string value "Redmine互換"
        datetime created_on "Redmine互換"
    }
    
    Organizations ||--o{ Users : belongs_to
    Users ||--o{ AuthSources : authenticated_by
    Users ||--o{ Tokens : has
    Roles ||--o{ PermissionsRoles : has
    Permissions ||--o{ PermissionsRoles : granted
```

### 2. プロジェクト・チケット管理ドメイン（Redmine基盤）

```mermaid
erDiagram
    Projects {
        UUID project_id PK "Redmine id互換"
        UUID organization_id FK "AI拡張"
        string name "Redmine互換"
        text description "Redmine互換"
        string homepage "Redmine互換"
        boolean is_public "Redmine互換"
        UUID parent_id FK "Redmine互換"
        int projects_count "Redmine互換"
        string project_type "AI拡張: strategic/research/development"
        UUID owner_id FK "AI拡張"
        datetime created_on "Redmine互換"
        datetime updated_on "Redmine互換"
    }
    
    Members {
        UUID member_id PK "Redmine id互換"
        UUID user_id FK "Redmine互換"
        UUID project_id FK "Redmine互換"
        UUID role_id FK "Redmine互換"
        datetime created_on "Redmine互換"
    }
    
    Issues {
        UUID issue_id PK "Redmine id互換"
        UUID tracker_id FK "Redmine互換"
        UUID project_id FK "Redmine互換"
        string subject "Redmine互換"
        text description "Redmine互換"
        date due_date "Redmine互換"
        UUID category_id FK "Redmine互換"
        UUID status_id FK "Redmine互換"
        UUID assigned_to_id FK "Redmine互換"
        UUID priority_id FK "Redmine互換"
        UUID fixed_version_id FK "Redmine互換"
        UUID author_id FK "Redmine互換"
        int lock_version "Redmine互換"
        string issue_type "AI拡張: manual/ai_automated/hybrid"
        json ai_config "AI拡張"
        datetime created_on "Redmine互換"
        datetime updated_on "Redmine互換"
    }
    
    Trackers {
        UUID tracker_id PK "Redmine id互換"
        string name "Redmine互換"
        boolean is_in_chlog "Redmine互換"
        string tracker_type "AI拡張: task/bug/feature/research"
        json ai_workflow_config "AI拡張"
    }
    
    IssueStatuses {
        UUID status_id PK "Redmine id互換"
        string name "Redmine互換"
        boolean is_closed "Redmine互換"
        boolean is_default "Redmine互換"
        string html_color "Redmine互換"
        boolean is_ai_processable "AI拡張"
    }
    
    IssueCategories {
        UUID category_id PK "Redmine id互換"
        UUID project_id FK "Redmine互換"
        string name "Redmine互換"
    }
    
    Versions {
        UUID version_id PK "Redmine id互換"
        UUID project_id FK "Redmine互換"
        string name "Redmine互換"
        text description "Redmine互換"
        date effective_date "Redmine互換"
        datetime created_on "Redmine互換"
        datetime updated_on "Redmine互換"
    }
    
    Workflows {
        UUID workflow_id PK
        UUID tracker_id FK "Redmine互換"
        UUID old_status_id FK "Redmine互換"
        UUID new_status_id FK "Redmine互換"
        UUID role_id FK "Redmine互換"
        boolean ai_automated "AI拡張"
        json ai_conditions "AI拡張"
    }
    
    Projects ||--o{ Members : has
    Projects ||--o{ Issues : contains
    Projects ||--o{ IssueCategories : categorizes
    Projects ||--o{ Versions : manages
    Issues ||--o{ Trackers : tracked_by
    Issues ||--o{ IssueStatuses : has_status
    Workflows ||--o{ Trackers : defines_for
    Workflows ||--o{ IssueStatuses : transitions
```
### 3. 添付ファイル・ドキュメント管理ドメイン（Redmine基盤）

```mermaid
erDiagram
    Attachments {
        UUID attachment_id PK "Redmine id互換"
        UUID container_id FK "Redmine互換"
        string container_type "Redmine互換"
        string filename "Redmine互換"
        string disk_filename "Redmine互換"
        int filesize "Redmine互換"
        string content_type "Redmine互換"
        string digest "Redmine互換"
        int downloads "Redmine互換"
        UUID author_id FK "Redmine互換"
        json ai_analysis "AI拡張"
        datetime created_on "Redmine互換"
    }
    
    Documents {
        UUID document_id PK "Redmine id互換"
        UUID project_id FK "Redmine互換"
        UUID category_id FK "Redmine互換"
        string title "Redmine互換"
        text description "Redmine互換"
        string document_type "AI拡張"
        json ai_metadata "AI拡張"
        datetime created_on "Redmine互換"
    }
    
    News {
        UUID news_id PK "Redmine id互換"
        UUID project_id FK "Redmine互換"
        string title "Redmine互換"
        string summary "Redmine互換"
        text description "Redmine互換"
        UUID author_id FK "Redmine互換"
        boolean ai_generated "AI拡張"
        datetime created_on "Redmine互換"
    }
    
    CustomFields {
        UUID custom_field_id PK "Redmine id互換"
        string type "Redmine互換"
        string name "Redmine互換"
        string field_format "Redmine互換"
        text possible_values "Redmine互換"
        string regexp "Redmine互換"
        int min_length "Redmine互換"
        int max_length "Redmine互換"
        boolean is_required "Redmine互換"
        boolean is_for_all "Redmine互換"
        boolean ai_processable "AI拡張"
    }
    
    CustomValues {
        UUID custom_value_id PK "Redmine id互換"
        string customized_type "Redmine互換"
        UUID customized_id FK "Redmine互換"
        UUID custom_field_id FK "Redmine互換"
        text value "Redmine互換"
    }
    
    Attachments ||--o{ Issues : attached_to
    Attachments ||--o{ Documents : attached_to
    Documents ||--o{ Projects : belongs_to
    News ||--o{ Projects : belongs_to
    CustomFields ||--o{ CustomValues : has_values
```

### 4. 履歴・監査・ワークフロー管理ドメイン（Redmine基盤）

```mermaid
erDiagram
    Journals {
        UUID journal_id PK "Redmine id互換"
        UUID journalized_id FK "Redmine互換"
        string journalized_type "Redmine互換"
        UUID user_id FK "Redmine互換"
        text notes "Redmine互換"
        datetime created_on "Redmine互換"
        boolean ai_generated "AI拡張"
        json ai_context "AI拡張"
    }
    
    JournalDetails {
        UUID journal_detail_id PK "Redmine id互換"
        UUID journal_id FK "Redmine互換"
        string property "Redmine互換"
        string prop_key "Redmine互換"
        text old_value "Redmine互換"
        text value "Redmine互換"
    }
    
    Watchers {
        UUID watcher_id PK "Redmine id互換"
        string watchable_type "Redmine互換"
        UUID watchable_id FK "Redmine互換"
        UUID user_id FK "Redmine互換"
        boolean ai_auto_watch "AI拡張"
        json notification_config "AI拡張"
    }
    
    Enumerations {
        UUID enumeration_id PK "Redmine id互換"
        string opt "Redmine互換"
        string name "Redmine互換"
        int position "Redmine追加"
        boolean is_default "Redmine追加"
        string type "Redmine追加"
    }
    
    Journals ||--o{ JournalDetails : contains
    Journals ||--o{ Issues : tracks_changes
    Watchers ||--o{ Issues : watches
    Watchers ||--o{ Projects : watches
```

### 5. AI・実行管理ドメイン（AI拡張）

```mermaid
erDiagram
    AIAgents {
        UUID agent_id PK
        UUID owner_id FK "Users参照"
        string agent_name
        string agent_type "strategic/research/development/quality/audit"
        json agent_config
        string status "active/inactive/maintenance"
        datetime last_execution_at
        datetime created_at
        datetime updated_at
    }
    
    Executions {
        UUID execution_id PK
        UUID agent_id FK
        UUID issue_id FK "Issues参照: Redmine連携"
        string execution_type "analysis/generation/monitoring/integration"
        json input_parameters
        string status "pending/running/completed/failed"
        datetime started_at
        datetime completed_at
        datetime created_at
    }
    
    ExecutionResults {
        UUID result_id PK
        UUID execution_id FK
        string result_type "report/code/analysis/recommendation"
        json result_data
        text summary
        float confidence_score
        boolean requires_approval
        datetime created_at
    }
    
    AIIssueLinks {
        UUID link_id PK
        UUID issue_id FK "Issues参照: Redmine連携"
        UUID agent_id FK
        UUID execution_id FK
        string link_type "automated/monitored/analyzed"
        json link_metadata
        datetime linked_at
    }
    
    AIAgents ||--o{ Executions : executes
    Executions ||--o{ ExecutionResults : produces
    AIIssueLinks ||--o{ Issues : links_to
    AIIssueLinks ||--o{ Executions : tracks
```

### 6. 人機協調・ワークフロー管理ドメイン（AI拡張）

```mermaid
erDiagram
    ApprovalFlows {
        UUID approval_id PK
        UUID execution_id FK "Executions参照"
        UUID requester_id FK "Users参照"
        UUID approver_id FK "Users参照"
        string approval_type "automatic/manual/escalated"
        string approval_status "pending/approved/rejected/timeout"
        text approval_reason
        text rejection_reason
        datetime requested_at
        datetime responded_at
        datetime expires_at
    }
    
    Reviews {
        UUID review_id PK
        UUID result_id FK "ExecutionResults参照"
        UUID reviewer_id FK "Users参照"
        string review_type "quality/security/compliance/content"
        int rating "1-5"
        text feedback
        json review_details
        string status "pending/completed/revision_required"
        datetime reviewed_at
    }
    
    WorkflowSteps {
        UUID step_id PK
        UUID workflow_id FK "Workflows参照: Redmine"
        string step_name
        int step_order
        string step_type "manual/automated/conditional"
        json step_config
        boolean is_required
        datetime created_at
    }
    
    ApprovalFlows ||--o{ Executions : approves
    Reviews ||--o{ ExecutionResults : reviews
    WorkflowSteps ||--o{ Workflows : defines
```

### 7. ナレッジ・学習管理ドメイン

```mermaid
erDiagram
    KnowledgeAssets {
        UUID asset_id PK
        string asset_name
        string asset_type "document/code/analysis/report/template"
        text description
        text content
        string file_path
        json metadata
        string tags
        UUID created_by FK
        string access_level "public/internal/restricted"
        boolean is_active
        datetime created_at
        datetime updated_at
    }
    
    KnowledgeVersions {
        UUID version_id PK
        UUID asset_id FK
        int version_number
        text change_description
        text content
        UUID modified_by FK
        datetime created_at
    }
    
    LearningPlans {
        UUID plan_id PK
        UUID learner_id FK
        string plan_name
        string learning_topic
        text learning_objectives
        string difficulty_level "beginner/intermediate/advanced"
        string status "draft/active/completed/cancelled"
        datetime start_date
        datetime target_completion_date
        datetime created_at
        datetime updated_at
    }
    
    LearningProgress {
        UUID progress_id PK
        UUID plan_id FK
        string milestone_name
        text description
        string status "not_started/in_progress/completed"
        float completion_percentage
        json assessment_results
        datetime completed_at
        datetime created_at
    }
    
    QualityChecks {
        UUID check_id PK
        UUID asset_id FK
        UUID result_id FK
        UUID checked_by FK
        string check_type "automated/manual/peer_review"
        string quality_score
        json check_results
        text feedback
        string status "passed/failed/needs_improvement"
        datetime checked_at
        datetime created_at
    }
    
    KnowledgeAssets ||--o{ KnowledgeVersions : has
    LearningPlans ||--o{ LearningProgress : tracks
    KnowledgeAssets ||--o{ QualityChecks : evaluated
    ExecutionResults ||--o{ QualityChecks : checked
```

### 8. 監査・ガバナンスドメイン

```mermaid
erDiagram
    AuditLogs {
        UUID audit_id PK
        UUID execution_id FK
        UUID user_id FK
        string event_type "create/read/update/delete/approve/execute"
        string resource_type "plan/task/knowledge/integration"
        UUID resource_id
        json before_state
        json after_state
        string ip_address
        string user_agent
        datetime timestamp
    }
    
    ComplianceChecks {
        UUID compliance_id PK
        UUID audit_id FK
        string compliance_type "data_protection/security/quality"
        string check_status "passed/failed/warning"
        json check_results
        text recommendations
        datetime checked_at
    }
    
    SecurityEvents {
        UUID event_id PK
        UUID user_id FK
        string event_type "login/logout/permission_change/suspicious_activity"
        string severity "low/medium/high/critical"
        text event_description
        json event_details
        string status "new/investigating/resolved"
        datetime detected_at
        datetime resolved_at
    }
    
    AuditLogs ||--o{ ComplianceChecks : triggers
```

### 9. 外部統合ドメイン

```mermaid
erDiagram
    IntegrationConfigs {
        UUID config_id PK
        UUID organization_id FK
        string integration_name
        string external_system "redmine/databricks/github/vscode"
        string connection_type "api/webhook/file_sync"
        json configuration_data
        json authentication_config
        string status "active/inactive/error"
        UUID created_by FK
        datetime last_sync_at
        datetime created_at
        datetime updated_at
    }
    
    IntegrationLogs {
        UUID log_id PK
        UUID config_id FK
        string operation_type "sync/push/pull/webhook"
        string status "success/error/partial"
        json request_data
        json response_data
        text error_message
        int retry_count
        datetime operation_timestamp
    }
    
    IntegrationConfigs ||--o{ IntegrationLogs : generates
```

## ドメイン間関係図

各ドメインがどのように相互に関連しているかを示すドメイン間関係図です。

```mermaid
erDiagram
    %% 主要エンティティ間の関係（ドメイン横断）
    Users ||--o{ Projects : owns
    Users ||--o{ Tasks : assigned_to
    Users ||--o{ AIAgents : configures
    Users ||--o{ StrategicPlans : creates
    Users ||--o{ ApprovalFlows : approves
    Users ||--o{ KnowledgeAssets : creates
    Users ||--o{ LearningPlans : owns
    Users ||--o{ AuditLogs : generates
    
    Projects ||--o{ StrategicPlans : implements
    Projects ||--o{ Workflows : uses
    
    Tasks ||--o{ Executions : triggers
    
    AIAgents ||--o{ Executions : performs
    
    Executions ||--o{ ExecutionResults : produces
    Executions ||--o{ ApprovalFlows : triggers
    Executions ||--o{ AuditLogs : generates
    
    ExecutionResults ||--o{ Reviews : receives
    ExecutionResults ||--o{ QualityChecks : checked
    
    Organizations ||--o{ Users : employs
    Organizations ||--o{ Projects : owns
    Organizations ||--o{ IntegrationConfigs : configures
```

## Redmine統合設計原則

### 基本方針
本システムは**Redmineを中枢管理システム**として活用し、既存のRedmineテーブル構造を最大限活用しつつ、AI機能拡張のための追加テーブルで補完する設計となっています。

### Redmine基盤テーブル活用

#### コアテーブル（完全互換）
- **Issues**: チケット管理（AI自動実行タスクも含む）
- **Projects**: プロジェクト管理（階層構造サポート）
- **Users**: ユーザ管理（人間・AIエージェント統合）
- **Workflows**: ステータス遷移（AI自動化サポート）
- **Trackers**: チケット種別（AI関連も分類）

#### 権限・認証テーブル（完全互換）
- **Roles/Permissions**: Redmine権限モデル活用
- **AuthSources**: 外部認証連携
- **Tokens**: API認証管理

#### 履歴・監査テーブル（完全互換）
- **Journals/JournalDetails**: 変更履歴追跡
- **Watchers**: 通知・監視設定
- **Attachments**: ファイル管理

#### 設定・マスタテーブル（完全互換）
- **Enumerations**: 列挙値マスタ
- **CustomFields/CustomValues**: カスタムフィールド

### AI機能拡張テーブル

#### AI実行管理
- **AIAgents**: AIエージェント管理
- **Executions**: AI実行履歴
- **ExecutionResults**: 実行結果管理
- **AIIssueLinks**: RedmineチケットとAI実行の連携

#### 組織・統合管理
- **Organizations**: マルチテナント対応
- **IntegrationConfigs**: 外部システム連携

### 統合メリット

1. **既存資産活用**: Redmineの豊富な機能・プラグインを継承
2. **学習コスト削減**: Redmine操作に慣れたユーザの負担軽減
3. **段階的導入**: 既存Redmine環境にAI機能を段階的に追加可能
4. **完全履歴**: RedmineのJournals機能でAI行動も含めて完全追跡

## エンティティ詳細説明

### 主要設計方針

#### 1. Redmine基盤統合による見やすさ向上
- Redmineコアテーブルを基盤とした9ドメイン分割
- AI拡張テーブルの明確な識別（"AI拡張"ラベル）
- Redmine互換性の明示（"Redmine互換"ラベル）

#### 2. 人機協調サポート
- **Users**: 人間とAIエージェントを統一的に管理（user_type拡張）
- **Issues**: RedmineチケットでAIタスクも管理（issue_type拡張）
- **AIAgents/Executions**: AIの全行動をRedmineと連携記録

#### 3. 完全履歴化
- **Journals**: Redmineの変更履歴にAI行動も記録
- **Attachments**: AI生成ファイルもRedmine添付として管理
- **変更履歴**: Redmine標準の created_on/updated_on 活用

#### 4. 柔軟な権限管理
- **Roles/Permissions**: Redmine標準権限モデル活用
- **Members**: プロジェクトメンバー管理（AI含む）
- **Workflows**: RedmineワークフローにAI自動化追加

#### 5. 統合基盤対応
- **CustomFields**: Redmine柔軟性でAI設定も管理
- **IntegrationConfigs**: Databricks/VS Code連携設定

## データ保護・セキュリティ考慮事項

### 機密情報保護
- Redmine標準権限モデルによるアクセス制御
- AI処理データの適切な分離・暗号化
- Redmine管理画面での統合セキュリティ管理

### 監査要件
- Redmine Journals機能による完全ログ記録
- AI実行履歴の詳細トレーサビリティ
- 承認プロセスのRedmine連携管理

### パフォーマンス考慮
- Redmine標準インデックス活用
- AI実行ログの効率的なパーティショニング
- Redmineキャッシュ機能との整合性確保

## 関連ドキュメント

- [035020_テーブル定義書.md](./035020_テーブル定義書.md): 詳細なテーブル仕様
- [021000_要件定義書.md](../../020000_要件定義/021000_要件定義書.md): システム要件
- [034020_ユースケース設計.md](../034000_アプリケーション設計/034020_ユースケース設計.md): ユースケース設計